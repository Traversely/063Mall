var orderData=orderData||{};$(".gotoorder-coupon").ready(function(){$(".coupon-select label").on("click",function(){$(this).next().toggle()}),$(".coupon-select ul").hover(function(){},function(){$(this).hide()});var e=function(){var e=$(".coupon-select li:eq(0)");e.addClass("active"),$(".coupon-select label").html(e.html()),$("#couponCode_select").val(e.data("couponCode"))};e(),$(".coupon-select li").on("click",function(){$(".coupon-select label").html($(this).html()),$("#couponCode_select").val($(this).data("couponCode")),$(this).parent().children().removeClass("active"),$(this).addClass("active"),$(this).parent().hide()}),$("#coupon-useOtherBtn").on("click",function(){$("#coupon2").hide(),$("#coupon1").show(),$("#couponCode_input").val(""),$("#coupon-tips").text("")}),$("#coupon-useMyBtn").on("click",function(){$("#coupon1").hide(),$("#coupon2").show(),$("#coupon-tips").text("")}),$("#coupon-useBtn1").on("click",function(){var e=$(this),n=$("#coupon-loadingBtn1"),r=$.trim($("#couponCode_input").val());if(!r){$("#coupon-tips").text("\u8bf7\u8f93\u5165\u4f18\u60e0\u7801!");return}e.hide(),n.show(),$("#coupon-tips").text(""),t(r,function(){n.hide(),e.show()})}),$("#coupon-useBtn2").on("click",function(){var e=$(this),n=$("#coupon-loadingBtn2"),r=$("#couponCode_select").val();if(!r){$("#coupon-tips").text("\u8bf7\u9009\u62e9\u4f18\u60e0\u5238!");return}e.hide(),n.show(),$("#coupon-tips").text(""),t(r,function(){n.hide(),e.show()})}),$("#coupon-cancelBtn").on("click",function(){$(".coupon-current s").html(""),$("#coupon-current").hide(),$("#coupon-use").show(),orderData.couponCode="",$("#zDiscount").text("\u4f18\u60e0\u62b5\u6263\uff1a-0.0\u5143"),$(".goodList .cont ul li").each(function(e,t){var n=$(t).attr("item_total")?$(t).attr("item_total"):0,r=$(t).find(".l4").not(".zp_l4");r.removeClass("l4b"),r.html('\u00a5<span class="allCount">'+parseFloat(n).toFixed(2)+"</span>")});var e=orderData.allCount+orderData.price_express;e=e<0?0:e,$("#tatalCount").text(e.toFixed(2))});var t=function(e,t){$.post("/shop/checksalecode",{salecode:e},function(r){t&&t();if(r.errno==0){if(n(r)){var i=r.full>0?"\u6ee1\u51cf":"\u7acb\u51cf";$(".coupon-current s").html("<span>["+i+"]</span>"+r.batch_title),orderData.couponCode=e,$("#coupon-use").hide(),$("#coupon-current").show()}}else $("#coupon-tips").text(r.errmsg)},"json")},n=function(e){var t=0;$(".goodList .cont ul li").each(function(n,r){var i=$(r).attr("item_id");if(e.item_id===null||e.item_id===""||e.item_id.length===0){if(!o(i,e.item_exclude_id)&&$(r).attr("item_total")){var u=$(r).attr("item_total");t+=parseFloat(u),$(r).addClass("js-coupon-valid").addClass("coupon-valid"),setTimeout(function(){$(r).find(".l4 s").show(),$(r).find(".l4 br").show(),$(r).find(".l4 .disCount").show()},1e3)}}else if(s(i,e.item_id)&&$(r).attr("item_total")){var u=$(r).attr("item_total");t+=parseFloat(u),$(r).addClass("js-coupon-valid").addClass("coupon-valid"),setTimeout(function(){$(r).find(".l4 s").show(),$(r).find(".l4 br").show(),$(r).find(".l4 .disCount").show()},1e3)}});if(t<=0)return $("#coupon-tips").text("\u60a8\u7684\u8ba2\u5355\u65e0\u6cd5\u4f7f\u7528\u6b64\u4f18\u60e0\u7801\u3002"),!1;var n=e.item_id?!1:!0;if(t<e.full)return $("#coupon-tips").text("\u60a8\u7684\u8ba2\u5355"+(n?"":"\u4e2d\u9650\u5b9a\u5546\u54c1\u7684")+"\u603b\u4ef7\u4e0d\u6ee1"+e.full+"\u5143\uff0c\u65e0\u6cd5\u4f7f\u7528\u6b64\u4f18\u60e0\u7801\u3002"),!1;var i=parseFloat(e.minus);if(e.type==3&&!n)i=0,$(".goodList .cont ul li").each(function(t,n){var u=$(n).attr("item_id");if(s(u,e.item_id)&&!o(u,e.item_exclude_id)&&$(n).attr("item_total")){var a=parseFloat($(n).attr("item_total"));if(a>=e.full){var f=$(n).attr("item_count")|0,l=parseFloat(parseFloat(e.minus)*f);l=l>a?a:l,i+=l,r($(n).find(".l4").not(".zp_l4"),a,l)}}});else{var u=i/t,a=0,f=$(".goodList .cont ul li").length;$(".goodList .cont ul li").each(function(t,n){var l=$(n).attr("item_id");if(s(l,e.item_id)&&!o(l,e.item_exclude_id)&&$(n).attr("item_total")){var c=parseFloat($(n).attr("item_total")),h=Math.round(u*c*10)/10;t==f-1&&(h=i-a),h=h>c?c:h,a+=h,r($(n).find(".l4").not(".zp_l4"),c,h)}}),i=a}$("#zDiscount").text("\u4f18\u60e0\u62b5\u6263\uff1a-"+i.toFixed(2)+"\u5143");var l=orderData.allCount-i;return l=l<0?0:l,l+=orderData.price_express,$("#tatalCount").text(l.toFixed(2)),!0},r=function(e,t,n){var r=t-n;e.addClass("l4b"),e.html('\u00a5<span class="allCount">'+parseFloat(r).toFixed(2)+"</span>"+"<s>\u00a5"+parseFloat(t).toFixed(2)+"</s><br/>"+'<span class="disCount">\u5df2\u7701 \u00a5<span>'+parseFloat(n).toFixed(2)+"</span></span>")},i=function(e){if(!e)return 1;var t="|"+e.join("|")+"|",n=0;return $(".goodList .cont ul li").each(function(e,r){var i=$(r).attr("item_id");t.indexOf("|"+i+"|")>-1&&(n+=$(r).find(".gcIpt span").text()|0)}),n},s=function(e,t){if(!t)return!0;var n=!1;return $.each(t,function(t,r){e==r&&(n=!0)}),n},o=function(e,t){return t===null?!1:-1!==$.inArray(e,t)}}),$(function(){$(".goodList").children(".cont").children("ul").children("li:last").addClass("nomgr"),$(".eleRadio").each(function(e){$(this).children("input")[0].checked==1?$(this).children("input").addClass("ip").before('<span class="rd rdc"></span>'):$(this).children("input").addClass("ip").before('<span class="rd"></span>')}),$(".eleRadioa").children(".eleRadio").click(function(e){$(this).index()==0?($(this).children(".rd").hasClass("rdc")||($(this).children(".rd").addClass("rdc"),$(this).siblings(".eleRadio").children(".rd").removeClass("rdc")),$("#nInvoice")[0].checked==1?($(".onlinePay").children(".con").hide(),$("#yInvoice")[0].checked=!1):$("#yInvoice")[0].checked==1&&($(".onlinePay").children(".con").hide(),$("#nInvoice")[0].checked=!0,$("#yInvoice")[0].checked=!1)):$(this).index()==1&&($(this).children(".rd").hasClass("rdc")||($(this).children(".rd").addClass("rdc"),$(this).siblings(".eleRadio").children(".rd").removeClass("rdc")),$("#nInvoice")[0].checked==1?($(".onlinePay").children(".con").show(),$("#yInvoice")[0].checked=!0,$("#nInvoice")[0].checked=!1):$("#yInvoice")[0].checked==1&&($(".onlinePay").children(".con").show(),$("#yInvoice")[0].checked=!0))}),$(".sltcate a").click(function(e){$(e.target).attr("id")=="sltcate_person"?$(this).hasClass("selected")||($(this).addClass("selected"),$(this).siblings("a").removeClass("selected"),$(".invoiceInfo").hide()):$(e.target).attr("id")=="sltcate_company"&&($(this).hasClass("selected")||($(this).addClass("selected"),$(this).siblings("a").removeClass("selected"),$(".invoiceInfo").show()))}),mall_page.has_bill==1&&$("#yInvoice").parent().click(),$(".consigneeinfo .formEle").size()==1&&(chose_ConsigneeTry("add"),$("#item_add").children(".eleRadio").children(".rd").addClass("rdc")),$(".l3").children(".gcIpt").children("span").each(function(e){$(this).text()&&(orderData.gCount+=parseInt($(this).text()))}),$(".gcIpt").children("span").each(function(){$(this).text()&&(orderData.gAmount+=parseInt($(this).text()))}),$(".allCount").each(function(){$(this).text()&&(orderData.allCount+=parseFloat($(this).text()))}),$("#gCount").text(orderData.gAmount),$("#zCount").text("\u91d1\u989d\u5408\u8ba1\uff1a"+orderData.allCount.toFixed(2)+"\u5143"),$("#tatalCount").text((orderData.allCount+orderData.price_express).toFixed(2)),$("#gCount").parents("total").css({visibility:"visible"}),$(".total").css({visibility:"visible"}),$("#coupon-useBtn2").click(),$(".delOrder").click(function(e){_this=$(this);var t=['<div class="dialog-delorder">','<div class="dialog-bar">',"\u6e29\u99a8\u63d0\u793a",'<a href="#" onclick="return false;" class="dialog-close" title="\u5173\u95ed"></a>',"</div>",'<div class="dialog-content">',"<p>\u60a8\u786e\u5b9a\u8981\u53d6\u6d88\u8ba2\u5355\u4e48\uff1f</p>","</div>",'<div class="dialog-console">','<a class="console-btn-confirm" href="#" onclick="return false;" title="\u786e\u8ba4">\u786e\u8ba4</a>','<a class="console-btn-cancel" href="#" onclick="return false;" title="\u53d6\u6d88">\u53d6\u6d88</a>',"</div>","</div>"].join(""),n=$(t).appendTo("body"),r=n.filter(".dialog-delorder"),i=_this.offset().top+20,s=_this.offset().left;r.css("top",i),r.css("left",s),n.filter(".dialog-bg").css("height",$(document).height()),n.find("a.console-btn-confirm").click(function(){$.post("/shop/delfromcart",{item_id:_this.attr("item_id"),qtoken:mall_page.qtoken,qtoken_timestamp:mall_page.qtoken_timestamp},function(e){e.errno==0?window.location.reload():e.errno==40001&&qikoo.dialog.alert(e.errmsg)},"json")}),n.find("a.console-btn-cancel,a.dialog-close").click(function(){window.location.reload()})})});